language: node_js

services:
  - docker

node_js:
  - '14'

addons:
  hostname: localhost

before_install:
  - export "PATH=C:\\Users\\travis\\build\\openverse\\OpenWorld\\openworld-desktop\\node_modules\\opencv-build\\opencv\\build\\include:C:\\Users\\travis\\build\\openverse\\OpenWorld\\openworld-desktop\\node_modules\\opencv-build\\opencv\\build\\include\\opencv2:C:\\Users\\travis\\build\\openverse\\OpenWorld\\openworld-desktop\\node_modules\\opencv\\build\\x64\\vc15\\bin:$PATH"

env:
  global:
  - OPENCV_INCLUDE_DIR=C:\\Users\\travis\\build\\openverse\\OpenWorld\\openworld-desktop\\node_modules\\opencv-build\\opencv\\build\\include
  - ELECTRON_CACHE=$HOME/.cache/electron
  - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
cache: npm

filter_secrets: false

addons:
  artifacts:
    s3_region: "us-west-1"
    paths:
      - ./dist/*.exe

jobs:
  include:
    - stage: Tests
      os: Windows
      env: YARN_GPG=no
      script:
        - cd openworld-desktop
        - npm install
#        - npm copy-bindings
        - npm run build:web
        - npm run build
        - 'npm run test:all || (node ./upload-vrt.js && exit 1)'

